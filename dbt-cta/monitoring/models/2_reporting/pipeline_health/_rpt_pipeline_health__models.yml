version: 2

models:
  - name: rpt_pipeline_health
    description: >
      A reporting model that joins the elementary dbt invocations and run results tables
      to produce a pipeline-run-level table (one row per sync, per partner, per airflow
      run) with high-level information about the status of a given pipeline run.
    columns:
      - name: dag_id
        description: >
          The ID of the DAG in airflow. This is _usually_ a concat of the sync name and
          the partner name, but may vary slightly for non-DMDF syncs.
      - name: sync_name
        description: >
          The name of the sync that this dbt run is a part of. Like in the intermediate
          tables, we allow for some slight nullness here when we're testing new syncs.

          To ensure this column and the partner name populates, be sure to add the DAG
          to our DAG Mapping Google Sheet.
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.95
      - name: partner_name
        description: >
          The name of the partner that this dbt project was run for
        tests:
          - dbt_utils.not_null_proportion:
              at_least: 0.95
      - name: run_id
        description: >
          The airflow run id that this dbt run was a part of.
        tests:
          - not_null
      - name: num_steps
        description: >
          The number of distinct dbt steps in a given dag. This is _usually_ six, (
          test CTA sources, run CTA, test CTA, test partner sources, run partner, test
          partner) but does vary across syncs.
      - name: num_steps_run
        description: >
          The number of dbt invocations that have been run for a given airflow run id.
          If everything succeeded on the first time, then num_steps == num_steps_run,
          but num_steps_run > num_steps if there were failures and re-runs.
      - name: run_started_at
        description: >
          The time at which the first dbt task in this pipeline run started. NOTE: this
          is just the dbt tasks, not the entire airflow/airbyte run.
      - name: run_completed_at
      - name: test_errors
      - name: successful_tests
      - name: total_tests
      - name: model_errors
      - name: successful_models
      - name: total_models
      - name: success
        description: A boolean indicating whether or not the pipeline run was successful.
      - name: success_int
        description: >
          An integer indicating whether or not the pipeline run was successful. 1 for
          success, 0 for failure.
      - name: most_recent_run_per_day
        description: >
          A boolean indicating whether or not this pipeline run is the most recent run
          for this sync, partner, and day.
      - name: runtime
    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: ["run_id","sync_name","partner_name"]
