# dbt-cta

## Welcome!

Whatever the events that conspired to bring you here, we at Community Tech Alliance welcome you to our humble repository, in which are contained most of our `dbt` models. As always, please [email us](mailto:help@techallies.org) with any questions, issues, or feature requests. We hope you enjoy your stay!

## Formatting

Until this is implemented in CI/CD, please run `sqlfmt`:
```shell
pipenv install
...
cd YOUR_DIRECTORY
pipenv run sqlfmt  .
```

## Cleanup Scripts

### Implementing dbt functions

Do *you* want to automatically replace all static references to tables as generated by Airbyte? I bet you do.

To replace ctes:

```shell
for file in $(ls mobilize/models/0_ctes/); do
	sed -i .bak -e 's/\`\prod.*\(_airbyte_raw_[^ ]*\)/{{ source("'"cta"'", "'"\1"'" \) }}/g' mobilize/models/0_ctes/$file;
done
```

To replace base tables:

```shell
for file in $(ls mobilize/models/1_cta_base_tables/); do
	sed -i .bak -e 's/\`\prod.*\(_airbyte_raw_[^ ]*\)/{{ source("'"cta"'", "'"\1"'" \) }}/g' mobilize/models/1_cta_base_tables/$file;
done
```

To build out materialized views, if applicable, run this sed replacement once you have the fields copied in from the base table:
```shell
sed -i .bak -e 's/    \([a-z0-9_]*\),/    ,max(\1) as \1/g' FILE.sql
```

Once you're sure things look good, delete the backups:

```shell
rm **/**/*.sql.bak
```
### Renaming files

For ctes:

```shell
for file in $(ls mobilize/models/0_ctes/); do
    newFile="${file#*airbyte_org_[0-9][a-z]*_}"
    mv mobilize/models/0_ctes/"$file" mobilize/models/0_ctes/"$newFile"
done
```

And base tables:
```shell
for file in $(ls mobilize/models/1_cta_base_tables/); do
    newFile="${file#*org_[0-9][a-z]*_}"
    mv mobilize/models/1_cta_base_tables/"$file" mobilize/models/1_cta_base_tables/"$newFile"
done
```
### Generating Sources

The sources.yml provides context to the dynamic lookups in the models. The file looks like this:
```
version: 2
sources:
- name: cta
  database: "{{ env_var('CTA_PROJECT_ID') }}"
  schema: "{{ env_var('CTA_DATASET_ID') }}"
  tables:
    - name: _airbyte_raw_affiliations
    - name: affiliatons
    ...
```

To generate the base set of sources (raw tables and base tables for `cta`) from the tables
loaded into BigQuery from the initial sync:

```shell
bq ls \
--project_id=prod8b61f23e \
dataset_id \
| jq '[{name: .[].tableReference.tableId}]_base' \
| yq -P
- name: event_co_hosts
- name: event_tags
...
```

From there, you can just copy and paste that into the sources.yml file.
